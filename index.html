<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Irrigation Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0c172c;
      --text:#e7eefc;
      --muted:#a9b6d3;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --line:#1f2f55;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 30% -10%, #183a7a55, transparent),
                  radial-gradient(1000px 700px at 100% 20%, #1e4ab655, transparent),
                  var(--bg);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:16px 18px;
      border-bottom:1px solid #17284a;
      background: linear-gradient(180deg, rgba(15,27,51,.75), rgba(15,27,51,.25));
      position:sticky; top:0; backdrop-filter: blur(10px);
      z-index:10;
    }
    .title{display:flex; gap:12px; align-items:center}
    .logo{font-size:26px}
    h1{margin:0; font-size:18px; font-weight:700}
    .subtitle{margin:2px 0 0; color:var(--muted); font-size:12px}
    .status{display:flex; gap:10px; align-items:center}
    .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--warn); box-shadow: 0 0 10px #f59e0b66;
    }
    .status span{font-size:12px; color:var(--muted)}
    .wrap{max-width:1180px; margin:0 auto; padding:18px}
    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid #1a2c52;
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .kpi{
      grid-column: span 3;
      min-height:92px;
    }
    .kpi .label{color:var(--muted); font-size:12px; display:flex; justify-content:space-between; gap:10px}
    .kpi .value{font-size:26px; margin-top:8px; font-weight:800; letter-spacing:.3px}
    .badge{
      font-size:11px; padding:3px 8px; border-radius:999px;
      border:1px solid #2a3e6f; color:var(--muted);
      background: rgba(15,27,51,.45);
      white-space:nowrap;
    }
    .badge.good{border-color:#1f7a3a; color:#baf7cf; background:#0e2b19}
    .badge.warn{border-color:#8a5b0e; color:#ffe6b4; background:#2a1a04}
    .badge.bad{border-color:#7a1f1f; color:#ffb7b7; background:#2a0c0c}

    .chart{
      grid-column: span 6;
      min-height:320px;
      padding:14px 14px 10px;
    }
    .chart h3{
      margin:0 0 10px;
      font-size:13px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.3px;
    }
    canvas{width:100% !important; height:250px !important;}
    .row2{margin-top:12px}
    .small{grid-column: span 4; min-height:320px}
    .note{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.4;
    }

    @media (max-width: 1000px){
      .kpi{grid-column: span 6;}
      .chart{grid-column: span 12;}
      .small{grid-column: span 12;}
    }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="title">
      <div class="logo">üå±</div>
      <div>
        <h1>Smart Irrigation Dashboard</h1>
        <p class="subtitle">ESP32 ‚Ä¢ Firebase RTDB ‚Ä¢ KPI & Graphs</p>
      </div>
    </div>

    <div class="status">
      <div id="connDot" class="dot"></div>
      <span id="connText">Connexion‚Ä¶</span>
      <span class="badge" id="lastUpdate">‚Äî</span>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- KPI CARDS -->
      <div class="card kpi">
        <div class="label">Temp√©rature Air <span class="badge" id="periodBadge">‚Äî</span></div>
        <div class="value"><span id="airTemp">--</span> ¬∞C</div>
      </div>

      <div class="card kpi">
        <div class="label">Humidit√© Air <span class="badge" id="pumpBadge">‚Äî</span></div>
        <div class="value"><span id="airRh">--</span> %</div>
      </div>

      <div class="card kpi">
        <div class="label">Humidit√© Sol <span class="badge" id="soilBadge">‚Äî</span></div>
        <div class="value"><span id="soil">--</span> %</div>
      </div>

      <div class="card kpi">
        <div class="label">Lumi√®re (Lux) <span class="badge">PPFD</span></div>
        <div class="value"><span id="lux">--</span> / <span id="ppfd">--</span></div>
      </div>

      <div class="card kpi">
        <div class="label">VPD <span class="badge">kPa</span></div>
        <div class="value"><span id="vpd">--</span></div>
      </div>

      <div class="card kpi">
        <div class="label">EDI <span class="badge">Demande</span></div>
        <div class="value"><span id="edi">--</span></div>
      </div>

      <div class="card kpi">
        <div class="label">Vent <span class="badge">m/s</span></div>
        <div class="value"><span id="wind">--</span></div>
      </div>

      <div class="card kpi">
        <div class="label">Pression <span class="badge">hPa</span></div>
        <div class="value"><span id="pressure">--</span></div>
      </div>

      <!-- CHARTS -->
      <div class="card chart">
        <h3>Temp√©rature & Humidit√© (Air)</h3>
        <canvas id="chartAir"></canvas>
      </div>

      <div class="card chart">
        <h3>Sol / Lumi√®re / Vent</h3>
        <canvas id="chartEnv"></canvas>
      </div>

      <div class="card small">
        <h3 style="margin:0 0 10px; color:var(--muted); font-size:13px;">Derni√®res valeurs (log)</h3>
        <div id="log" class="note"></div>
      </div>

      <div class="card small">
        <h3 style="margin:0 0 10px; color:var(--muted); font-size:13px;">KPIs (rappel)</h3>
        <div class="note" id="kpiText">
          ‚Ä¢ Commande bas√©e sur facteurs (p√©riode via lumi√®re), temp√©rature, RH, rayonnement, vent.<br>
          ‚Ä¢ Le sol est conserv√© en mesure pour validation des calculs (pas de commande directe si vous le souhaitez).
        </div>
      </div>

      <div class="card small">
        <h3 style="margin:0 0 10px; color:var(--muted); font-size:13px;">√âtat</h3>
        <div class="note" id="stateText">‚Äî</div>
      </div>
    </section>
  </main>

  <script>
    // ===================== FIREBASE RTDB (REST) =====================
    const FIREBASE_DB = "https://smart-irrigation-site-90e51-default-rtdb.firebaseio.com";
    const DB_PATH = "/readings"; // <-- ÿ®ÿØŸÑŸäŸáÿß ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© ŸÅŸÄ ESP
    const LIMIT = 60;            // ÿπÿØÿØ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÅÿßŸÑ⁄Øÿ±ÿßŸÅ

    // ÿ•ÿ∞ÿß ÿπŸÜÿØŸÉŸÖ rules public ŸÖÿß ÿ™ÿ≠ÿ™ÿßÿ¨Ÿàÿ¥ auth
    function buildUrlLatest() {
      // latest by key
      return `${FIREBASE_DB}${DB_PATH}.json?orderBy="$key"&limitToLast=1`;
    }
    function buildUrlHistory() {
      return `${FIREBASE_DB}${DB_PATH}.json?orderBy="$key"&limitToLast=${LIMIT}`;
    }

    // ===================== HELPERS =====================
    const el = id => document.getElementById(id);
    const fmt = (v, d=1) => (v===null || v===undefined || Number.isNaN(v)) ? "--" : Number(v).toFixed(d);

    function setConn(ok){
      el("connDot").style.background = ok ? "var(--good)" : "var(--bad)";
      el("connDot").style.boxShadow = ok ? "0 0 10px #22c55e66" : "0 0 10px #ef444466";
      el("connText").textContent = ok ? "Connect√©" : "Hors ligne";
    }

    // VPD (kPa) from T (¬∞C) and RH (%)
    function computeVPD(T, RH){
      if(!isFinite(T) || !isFinite(RH)) return NaN;
      const es = 0.6108 * Math.exp((17.27*T)/(T+237.3));
      const ea = es * (RH/100);
      return es - ea;
    }

    // P√©riode depuis PPFD (m√™me logique ESP)
    const PPFD_NIGHT_TH=30, PPFD_MORNING_TH=120, PPFD_EVENING_TH=250;
    function periodFromPPFD(ppfd){
      if(!isFinite(ppfd)) return "NIGHT";
      if(ppfd < PPFD_NIGHT_TH) return "NIGHT";
      if(ppfd < PPFD_MORNING_TH) return "MORN";
      if(ppfd < PPFD_EVENING_TH) return "EVE";
      return "DAY";
    }
    function F_time(period){
      if(period==="NIGHT") return 0.6;
      if(period==="DAY") return 1.3;
      return 1.0;
    }

    // EDI = product of factors like in ESP (proxy)
    const ALPHA_T=0.05, BETA_RH=0.02, GAMMA_R=0.001;
    // KPI thresholds (Tomate default)
    const T_OPT_MAX=26, RH_MIN=60, PPFD_OPT_MAX=350;

    function F_T(T){
      if(!isFinite(T)) return 1.0;
      if(T <= T_OPT_MAX) return 1.0;
      return 1.0 + ALPHA_T * (T - T_OPT_MAX);
    }
    function F_RH(RH){
      if(!isFinite(RH)) return 1.0;
      if(RH >= RH_MIN) return 1.0;
      return 1.0 + BETA_RH * (RH_MIN - RH);
    }
    function F_R(PPFD){
      if(!isFinite(PPFD)) return 1.0;
      if(PPFD <= PPFD_OPT_MAX) return 1.0;
      return 1.0 + GAMMA_R * (PPFD - PPFD_OPT_MAX);
    }
    function clamp(x,a,b){ return Math.min(b, Math.max(a, x)); }

    function computeEDI({tAir,rh,ppfd}){
      const p = periodFromPPFD(ppfd);
      const edi = clamp(F_time(p),0.5,1.5) * clamp(F_T(tAir),0.8,1.8) * clamp(F_RH(rh),0.8,1.8) * clamp(F_R(ppfd),0.8,1.8);
      return {edi, period:p};
    }

    // wind field fallback
    function getWind(obj){
      const candidates = ["wind", "wind_ms", "windSpeed", "wind_speed", "anemo_ms", "anemometer", "vent"];
      for(const k of candidates){
        if(obj && isFinite(obj[k])) return Number(obj[k]);
      }
      return NaN;
    }

    // ===================== CHARTS =====================
    let chartAir, chartEnv;

    function makeCharts(){
      const ctxAir = document.getElementById("chartAir").getContext("2d");
      const ctxEnv = document.getElementById("chartEnv").getContext("2d");

      chartAir = new Chart(ctxAir, {
        type: "line",
        data: { labels: [], datasets: [
          { label: "Temp (¬∞C)", data: [], tension:0.25, borderWidth:2, pointRadius:0 },
          { label: "RH (%)", data: [], tension:0.25, borderWidth:2, pointRadius:0 },
        ]},
        options: {
          responsive:true,
          plugins:{ legend:{ labels:{ color:"#cfe0ff" } } },
          scales:{
            x:{ ticks:{ color:"#a9b6d3" }, grid:{ color:"#1f2f55" } },
            y:{ ticks:{ color:"#a9b6d3" }, grid:{ color:"#1f2f55" } },
          }
        }
      });

      chartEnv = new Chart(ctxEnv, {
        type: "line",
        data: { labels: [], datasets: [
          { label: "Sol (%)", data: [], tension:0.25, borderWidth:2, pointRadius:0 },
          { label: "PPFD", data: [], tension:0.25, borderWidth:2, pointRadius:0 },
          { label: "Vent (m/s)", data: [], tension:0.25, borderWidth:2, pointRadius:0 },
        ]},
        options: {
          responsive:true,
          plugins:{ legend:{ labels:{ color:"#cfe0ff" } } },
          scales:{
            x:{ ticks:{ color:"#a9b6d3" }, grid:{ color:"#1f2f55" } },
            y:{ ticks:{ color:"#a9b6d3" }, grid:{ color:"#1f2f55" } },
          }
        }
      });
    }

    function updateCharts(points){
      // points: array sorted
      const labels = points.map(p => p._t || p._key.slice(-4)); // last digits of key if no time
      chartAir.data.labels = labels;
      chartAir.data.datasets[0].data = points.map(p => p.air_temp);
      chartAir.data.datasets[1].data = points.map(p => p.air_rh);
      chartAir.update("none");

      chartEnv.data.labels = labels;
      chartEnv.data.datasets[0].data = points.map(p => p.soil);
      chartEnv.data.datasets[1].data = points.map(p => p.ppfd);
      chartEnv.data.datasets[2].data = points.map(p => p.wind);
      chartEnv.update("none");
    }

    // ===================== UI UPDATE =====================
    function badge(elm, txt, cls){
      elm.textContent = txt;
      elm.classList.remove("good","warn","bad");
      if(cls) elm.classList.add(cls);
    }

    function updateUI(latest){
      const tAir = Number(latest.air_temp);
      const rh   = Number(latest.air_rh);
      const soil = Number(latest.soil);
      const lux  = Number(latest.lux);
      const ppfd = Number(latest.ppfd);
      const pressure = Number(latest.pressure_hpa);
      const pump = latest.pump || "--";
      const wind = getWind(latest);

      // Compute VPD + EDI
      const vpd = computeVPD(tAir, rh);
      const {edi, period} = computeEDI({tAir, rh, ppfd});

      el("airTemp").textContent = fmt(tAir,1);
      el("airRh").textContent   = fmt(rh,0);
      el("soil").textContent    = fmt(soil,0);
      el("lux").textContent     = fmt(lux,0);
      el("ppfd").textContent    = fmt(ppfd,0);

      el("vpd").textContent     = fmt(vpd,2);
      el("edi").textContent     = fmt(edi,2);

      el("wind").textContent    = fmt(wind,2);
      el("pressure").textContent= fmt(pressure,1);

      // Period badge
      badge(el("periodBadge"), period, period==="DAY" ? "good" : (period==="NIGHT" ? "bad" : "warn"));

      // Pump badge
      badge(el("pumpBadge"), pump, pump==="ON" ? "warn" : "good");

      // Soil badge simple info
      if(isFinite(soil)){
        let cls="good", txt="OK";
        if(soil < 40) {cls="bad"; txt="SEC";}
        else if(soil < 55) {cls="warn"; txt="BAS";}
        badge(el("soilBadge"), txt, cls);
      } else badge(el("soilBadge"), "‚Äî", "");

      // last update
      const now = new Date();
      el("lastUpdate").textContent = now.toLocaleTimeString();

      // state text
      el("stateText").innerHTML =
        `P√©riode: <b>${period}</b><br>` +
        `Pompe: <b>${pump}</b><br>` +
        `VPD: <b>${fmt(vpd,2)} kPa</b> ‚Ä¢ EDI: <b>${fmt(edi,2)}</b><br>` +
        `Vent: <b>${fmt(wind,2)} m/s</b> ‚Ä¢ Pression: <b>${fmt(pressure,1)} hPa</b>`;
    }

    function updateLog(latest){
      const wind = getWind(latest);
      const rows = [
        `air_temp: ${latest.air_temp}`,
        `air_rh: ${latest.air_rh}`,
        `soil: ${latest.soil}`,
        `lux: ${latest.lux}`,
        `ppfd: ${latest.ppfd}`,
        `wind: ${isFinite(wind)?wind:"(no field)"} `,
        `bmp_temp: ${latest.bmp_temp}`,
        `pressure_hpa: ${latest.pressure_hpa}`,
        `pump: ${latest.pump}`,
        `period: ${latest.period}`
      ];
      el("log").innerHTML = rows.map(r => `‚Ä¢ ${r}`).join("<br>");
    }

    // ===================== FETCH =====================
    async function fetchJson(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error("HTTP " + r.status);
      return await r.json();
    }

    function normalizeHistory(obj){
      // obj is key -> payload
      if(!obj) return [];
      const keys = Object.keys(obj).sort();
      return keys.map(k => {
        const v = obj[k] || {};
        const wind = getWind(v);
        return {
          _key:k,
          _t: v.time || v.timestamp || v.ts || null,
          air_temp: Number(v.air_temp),
          air_rh: Number(v.air_rh),
          soil: Number(v.soil),
          lux: Number(v.lux),
          ppfd: Number(v.ppfd),
          wind: isFinite(wind) ? wind : NaN
        };
      });
    }

    async function refresh(){
      try{
        const [latestObj, histObj] = await Promise.all([
          fetchJson(buildUrlLatest()),
          fetchJson(buildUrlHistory())
        ]);

        setConn(true);

        // latestObj is {key:{...}}
        const latestKey = latestObj ? Object.keys(latestObj)[0] : null;
        const latest = latestKey ? latestObj[latestKey] : null;

        if(latest){
          updateUI(latest);
          updateLog(latest);
        }

        const points = normalizeHistory(histObj);
        if(points.length) updateCharts(points);

      }catch(e){
        setConn(false);
        el("connText").textContent = "Erreur Firebase";
      }
    }

    // ===================== INIT =====================
    makeCharts();
    refresh();
    setInterval(refresh, 2500);
  </script>
</body>
</html>
