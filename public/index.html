<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Smart Irrigation Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial;margin:20px}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .card{padding:12px;border:1px solid #ddd;border-radius:10px}
    canvas{max-width:100%;margin-top:18px}
  </style>
</head>
<body>
  <h2>Smart Irrigation Dashboard</h2>

  <div class="grid">
    <div class="card"><b>Air Temp (°C)</b><div id="t">--</div></div>
    <div class="card"><b>Air RH (%)</b><div id="rh">--</div></div>
    <div class="card"><b>Soil (%)</b><div id="soil">--</div></div>
    <div class="card"><b>Lux</b><div id="lux">--</div></div>
    <div class="card"><b>PPFD</b><div id="ppfd">--</div></div>
    <div class="card"><b>Pump / Period</b><div id="pump">--</div></div>
  </div>

  <h3>Graphs</h3>
  <canvas id="tempChart"></canvas>
  <canvas id="soilChart"></canvas>

<script>
  const tempChart = new Chart(document.getElementById("tempChart"), {
    type:"line",
    data:{labels:[], datasets:[{label:"Air Temp (°C)", data:[]}]}
  });

  const soilChart = new Chart(document.getElementById("soilChart"), {
    type:"line",
    data:{labels:[], datasets:[{label:"Soil (%)", data:[]}]}
  });

  async function refresh(){
    const res = await fetch("/api/history?limit=30");
    const data = await res.json();
    if(!data.length) return;

    const labels = data.map(x => new Date(x.created_at).toLocaleTimeString());
    tempChart.data.labels = labels;
    soilChart.data.labels = labels;

    tempChart.data.datasets[0].data = data.map(x => x.air_temp);
    soilChart.data.datasets[0].data = data.map(x => x.soil);

    tempChart.update();
    soilChart.update();

    const last = data[data.length-1];
    document.getElementById("t").textContent = last.air_temp ?? "--";
    document.getElementById("rh").textContent = last.air_rh ?? "--";
    document.getElementById("soil").textContent = last.soil ?? "--";
    document.getElementById("lux").textContent = last.lux ?? "--";
    document.getElementById("ppfd").textContent = last.ppfd ?? "--";
    document.getElementById("pump").textContent = `${last.pump} / ${last.period}`;
  }

  setInterval(refresh, 3000);
  refresh();
</script>
</body>
</html>
